---
import ogs from 'open-graph-scraper';

export interface Props {
	url: string;
	title?: string;
	showOgImage?: boolean;
}

async function getOgData(url: string): Promise<{ title?: string; image?: string }> {
	try {
		const { result } = await ogs({ url, fetchOptions: { headers: { 'user-agent': 'bot' } } });
		return {
			title: result.ogTitle || result.twitterTitle || undefined,
			image: result.ogImage?.[0]?.url,
		};
	} catch (error) {
		console.error(`Failed to fetch OGP data for ${url}:`, error);
		return {};
	}
}

const { url, title: providedTitle, showOgImage = true } = Astro.props;

const ogData = await getOgData(url);
const title = providedTitle || ogData.title || url;
const ogImageUrl = showOgImage ? ogData.image : undefined;
---

<div class="flex flex-row justify-stretch items-stretch w-full rounded-xl h-24 bg-app-bg">
  <div class="flex flex-col self-stretch p-6 flex-1 justify-between min-w-0">
      <h2 class="text-lg font-bold leading-none text-app-text truncate">
        <a href={url} target="_blank" rel="noopener noreferrer">{title}</a>
      </h2>
      <slot name="bottom-content" />
  </div>
  {ogImageUrl && (
    <div class="flex flex-row justify-end items-center h-full flex-shrink-0">
        <img
          src={ogImageUrl}
          alt={title}
          class="w-24 h-24 md:w-[168px] md:h-24 rounded-r-xl object-cover"
        />
    </div>
  )}
</div>

