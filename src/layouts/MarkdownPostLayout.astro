---
import type { CollectionEntry } from "astro:content";

import { render } from "astro:content";
import { Image } from "astro:assets";

import ArticleHeader from '../components/ui/ArticleHeader.astro';
import Toc from '../components/Toc.astro';
import ArticleCard from '../components/ArticleCard.astro';
import TocButton from '../components/TocButton.astro';
import { HEADING_LEVEL } from '../config';

type Props = {
  entry: CollectionEntry<'blog'>;
  prevArticle?: CollectionEntry<'blog'>;
  nextArticle?: CollectionEntry<'blog'>;
};

const { entry, prevArticle, nextArticle } = Astro.props;
const { title, pubDate, tags } = entry.data;
const heroImage = entry.data.heroImage as ImageMetadata | undefined;
const { headings } = await render(entry);
const { id } = entry;

const filteredHeadings = headings.filter(heading => heading.depth <= HEADING_LEVEL);
const hasHeadings = filteredHeadings.length > 0;
---

{hasHeadings && (
	<!-- TocButtonを非表示でレンダリング（後でHeaderに移動される） -->
	<div id="toc-button-source" class="hidden">
		<div 
			x-data 
			x-show="$store.tocButton.show" 
			x-transition.duration.300ms 
			x-cloak 
		>
			<TocButton headings={filteredHeadings} />
		</div>
	</div>
)}

<article class="flex flex-col gap-9">
	<div class="px-6">
  	<ArticleHeader id={id} pubDate={pubDate} tags={tags} title={title} />
	</div>
  {heroImage && (
    <div class="w-full rounded-xl overflow-hidden" transition:name={`hero-image-${id}`}>
      <Image width={1080} height={540} src={heroImage} alt={title} class="w-full h-auto" />
    </div>
  )}
	{hasHeadings && (
		// Tocコンポーネント側でIntersection Observerを設置している
  	<Toc headings={filteredHeadings} />
	)}
  <slot />
</article>
{(prevArticle || nextArticle) && (
  <div class="flex flex-col gap-6 px-6 pt-12 mt-12 border-t border-app-border-default">
    {nextArticle && (
      <div class="flex flex-col gap-2.5">
        <h3 class="text-base font-bold text-app-text">
          Next
        </h3>
        <ArticleCard entry={nextArticle} />
      </div>
    )}
    {prevArticle && (
      <div class="flex flex-col gap-2.5">
        <h3 class="text-base font-bold text-app-text">
          Previous
        </h3>
        <ArticleCard entry={prevArticle} />
      </div>
    )}
  </div>
)}

<script is:inline>
	// 初期化済みフラグとObserverの参照を保持
	let isInitialized = false;

	// TocButtonをHeaderのコンテナに移動
	const moveTocButton = () => {
		const source = document.getElementById('toc-button-source');
		const slot = document.getElementById('toc-button-slot');
		
		// 既に移動済みの場合は何もしない
		if (!source || !slot || slot.children.length > 0) {
			return;
		}

		if (source.firstElementChild) {
			slot.innerHTML = '';
			slot.appendChild(source.firstElementChild);
			source.remove();
		}
	};

	const setupTocToggle = () => {
		const store = Alpine.store('tocButton');
		if (!store) return;
	};

	const initTocButton = () => {
		if (isInitialized) {
			return;
		}

		if (typeof Alpine === 'undefined') {
			return;
		}

		if (!Alpine.store('tocButton')) {
			Alpine.store("tocButton", {
				show: false,
				toggleShow() {
					this.show = !this.show;
				},
				expanded: false,
				toggleExpanded() {
					this.expanded = !this.expanded;
				}
			});
		}

		moveTocButton();
		setupTocToggle();
		isInitialized = true;
	};

	// 初期化関数（ページ遷移時にリセット）
	const resetAndInit = () => {
		isInitialized = false;
		initTocButton();
	};

	// Alpine.jsの初期化を待つ
	document.addEventListener('alpine:init', () => {
		initTocButton();
	});

	document.addEventListener('astro:page-load', () => {
		resetAndInit();
	});

</script>
