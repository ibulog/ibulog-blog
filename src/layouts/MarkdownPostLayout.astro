---
import type { CollectionEntry } from "astro:content";

import { render } from "astro:content";
import { Image } from "astro:assets";

import ArticleHeader from '../components/ui/ArticleHeader.astro';
import ArticleIndex from '../components/ArticleIndex.astro';
import ArticleCard from '../components/ArticleCard.astro';
import ArticleIndexBar from '../components/ArticleIndexBar.astro';
import { HEADING_LEVEL } from '../config';

type Props = {
  entry: CollectionEntry<'blog'>;
  prevArticle?: CollectionEntry<'blog'>;
  nextArticle?: CollectionEntry<'blog'>;
};

const { entry, prevArticle, nextArticle } = Astro.props;
const { title, pubDate, tags } = entry.data;
const heroImage = entry.data.heroImage as ImageMetadata | undefined;
const { headings } = await render(entry);
const { id } = entry;

const filteredHeadings = headings.filter(heading => heading.depth <= HEADING_LEVEL);
const hasHeadings = filteredHeadings.length > 0;
---

{hasHeadings && (
	<!-- ArticleIndexBarを非表示でレンダリング（後でHeaderに移動される） -->
	<div id="article-index-bar-source" class="hidden">
		<div 
			x-data 
			x-show="$store.articleIndexBar.show" 
			x-transition.duration.300ms 
			x-cloak 
		>
			<ArticleIndexBar headings={filteredHeadings} />
		</div>
	</div>
)}

<article class="flex flex-col gap-9">
  <ArticleHeader id={id} pubDate={pubDate} tags={tags} title={title} />
  {heroImage && (
    <div class="w-full rounded-xl overflow-hidden" transition:name={`hero-image-${id}`}>
      <Image width={1080} height={540} src={heroImage} alt={title} class="w-full h-auto" />
    </div>
  )}
	{hasHeadings && (
  	<ArticleIndex headings={filteredHeadings} id="article-index" />
	)}
  <slot />
</article>
{(prevArticle || nextArticle) && (
  <div class="flex flex-col gap-6 pt-12 mt-12 border-t border-app-border-default-reverse">
    {nextArticle && (
      <div class="flex flex-col gap-2.5">
        <h3 class="text-base font-bold text-app-text">
          Next
        </h3>
        <div class="px-3">
          <ArticleCard entry={nextArticle} />
        </div>
      </div>
    )}
    {prevArticle && (
      <div class="flex flex-col gap-2.5">
        <h3 class="text-base font-bold text-app-text">
          Previous
        </h3>
        <div class="px-3">
          <ArticleCard entry={prevArticle} />
        </div>
      </div>
    )}
  </div>
)}

<script is:inline>
	// ArticleIndexBarをHeaderのコンテナに移動
	const moveArticleIndexBar = () => {
		const source = document.getElementById('article-index-bar-source');
		const slot = document.getElementById('article-index-bar-slot');
		
		if (source && slot) {
			slot.innerHTML = '';
			slot.appendChild(source.firstElementChild);
			source.remove();
		}
	};

		const setupIndexToggle = () => {
		const articleIndex = document.getElementById('article-index');
		if (!articleIndex) return;

		const store = Alpine.store('articleIndexBar');
		if (!store) return;

		// 目次が表示されているかどうかを監視
		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					if (!entry.isIntersecting) {
						store.show = true;
					} else {
						store.show = false;
					}
				});
			},
			{
				threshold: 0,
			}
		);

		observer.observe(articleIndex);
	};

	// Alpine.js Store初期化とセットアップ
	const initArticleIndexBar = () => {
		Alpine.store("articleIndexBar", {
			show: false,
			toggleShow() {
				this.show = !this.show;
			},
			expanded: false,
			toggleExpanded() {
				this.expanded = !this.expanded;
			}
		});

		moveArticleIndexBar();
		setupIndexToggle();
	};

	// Alpine.jsの初期化を待つ
	document.addEventListener('alpine:init', () => {
		initArticleIndexBar();
	});

	document.addEventListener('astro:page-load', () => {
		document.addEventListener('alpine:init', () => {
			initArticleIndexBar();
		}, { once: true });
	});
</script>
