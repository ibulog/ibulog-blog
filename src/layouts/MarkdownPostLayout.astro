---
import type { CollectionEntry } from "astro:content";

import { render } from "astro:content";
import { Image } from "astro:assets";

import ArticleHeader from '../components/ui/ArticleHeader.astro';
import ArticleIndex from '../components/ArticleIndex.astro';
import ArticleCard from '../components/ArticleCard.astro';
import ArticleIndexBar from '../components/ui/ArticleIndexBar.astro';

type Props = {
  entry: CollectionEntry<'blog'>;
  prevArticle?: CollectionEntry<'blog'>;
  nextArticle?: CollectionEntry<'blog'>;
};

const { entry, prevArticle, nextArticle } = Astro.props;
const { title, pubDate, tags } = entry.data;
const heroImage = entry.data.heroImage as ImageMetadata | undefined;
const { headings } = await render(entry);
const { id } = entry;

const filteredHeadings = headings.filter(heading => heading.depth < 3);

---

{filteredHeadings.length > 0 && (
	<div class="sticky top-[100px] z-40 w-full px-3 flex flex-col items-center transition-opacity duration-300 opacity-0 pointer-events-none" id="index-toggle-bar">
		<ArticleIndexBar headings={headings} />
	</div>
)}

<article class="flex flex-col gap-9">
  <ArticleHeader id={id} pubDate={pubDate} tags={tags} title={title} />
  {heroImage && (
    <div class="w-full rounded-xl overflow-hidden" transition:name={`hero-image-${id}`}>
      <Image width={1080} height={540} src={heroImage} alt={title} class="w-full h-auto" />
    </div>
  )}
  <ArticleIndex headings={headings} id="article-index" />
  <slot />
</article>
{(prevArticle || nextArticle) && (
  <div class="flex flex-col gap-6 pt-12 mt-12 border-t border-app-border-default-reverse">
    {nextArticle && (
      <div class="flex flex-col gap-2.5">
        <h3 class="text-base font-bold leading-none text-app-text">
          Next
        </h3>
        <div class="px-3">
          <ArticleCard entry={nextArticle} />
        </div>
      </div>
    )}
    {prevArticle && (
      <div class="flex flex-col gap-2.5">
        <h3 class="text-base font-bold leading-none text-app-text">
          Previous
        </h3>
        <div class="px-3">
          <ArticleCard entry={prevArticle} />
        </div>
      </div>
    )}
  </div>
)}

<script is:inline>
	const setupIndexToggle = () => {
		const articleIndex = document.getElementById('article-index');
		const toggleBar = document.getElementById('index-toggle-bar');
		const toggleButton = document.getElementById('index-toggle-button');
		const expandableContainer = document.getElementById('index-expandable-container');
		const indexContent = document.getElementById('index-content');

		if (!articleIndex || !toggleBar || !toggleButton || !expandableContainer || !indexContent) return;

		toggleButton.addEventListener('click', (event) => {
			event.stopPropagation();
			const isOpened = expandableContainer.classList.contains('w-full');
			
			if (isOpened) {
				indexContent.classList.remove('grid-rows-[1fr]');
				indexContent.classList.add('grid-rows-[0fr]');
				expandableContainer.classList.remove('w-full');
				expandableContainer.classList.add('w-20');
				toggleButton.setAttribute('aria-label', '目次を開く');
			} else {
				expandableContainer.classList.remove('w-20');
				expandableContainer.classList.add('w-full');
				indexContent.classList.remove('grid-rows-[0fr]');
				indexContent.classList.add('grid-rows-[1fr]');
				toggleButton.setAttribute('aria-label', '目次を閉じる');
			}
		});

		const indexLinks = indexContent.querySelectorAll('a');
		indexLinks.forEach(link => {
			link.addEventListener('click', () => {
				indexContent.classList.remove('grid-rows-[1fr]');
				indexContent.classList.add('grid-rows-[0fr]');
				expandableContainer.classList.remove('w-full');
				expandableContainer.classList.add('w-20');
				toggleButton.setAttribute('aria-label', '目次を開く');
			});
		});

		const header = document.getElementById('site-header');
		const headerHeight = header ? header.offsetHeight : 64;
		const rootMargin = `-${headerHeight + 24}px 0px 0px 0px`;

		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					if (!entry.isIntersecting) {
						toggleBar.classList.remove('hidden');
						toggleBar.classList.remove('pointer-events-none');
						toggleBar.classList.remove('opacity-0');
						toggleBar.classList.add('opacity-100');
					} else {
						toggleBar.classList.remove('opacity-100');
						toggleBar.classList.add('opacity-0');
						if (expandableContainer.classList.contains('w-full')) {
							indexContent.classList.remove('grid-rows-[1fr]');
							indexContent.classList.add('grid-rows-[0fr]');
							expandableContainer.classList.remove('w-full');
							expandableContainer.classList.add('w-20');
							toggleButton.setAttribute('aria-label', '目次を開く');
						}
						toggleBar.classList.add('hidden');
						toggleBar.classList.add('pointer-events-none');
					}
				});
			},
			{
				rootMargin,
				threshold: 0,
			}
		);

		observer.observe(articleIndex);

		window.__indexToggleObserver = observer;
	};

	setupIndexToggle();

	document.addEventListener('astro:after-swap', () => {
		if (window.__indexToggleObserver) {
			window.__indexToggleObserver.disconnect();
			window.__indexToggleObserver = null;
		}
		setupIndexToggle();
	});
</script>
