---
import type { CollectionEntry } from "astro:content";

import { render } from "astro:content";
import { Image } from "astro:assets";

import ArticleHeader from '../components/ui/ArticleHeader.astro';
import ArticleIndex from '../components/ArticleIndex.astro';
import ArticleCard from '../components/ArticleCard.astro';
import ArticleIndexBar from '../components/ArticleIndexBar.astro';
import { HEADING_LEVEL } from '../config';

type Props = {
  entry: CollectionEntry<'blog'>;
  prevArticle?: CollectionEntry<'blog'>;
  nextArticle?: CollectionEntry<'blog'>;
};

const { entry, prevArticle, nextArticle } = Astro.props;
const { title, pubDate, tags } = entry.data;
const heroImage = entry.data.heroImage as ImageMetadata | undefined;
const { headings } = await render(entry);
const { id } = entry;

const filteredHeadings = headings.filter(heading => heading.depth <= HEADING_LEVEL);

---

{filteredHeadings.length > 0 && (
	<div x-show="$store.articleIndexBar.show" x-collapse class="sticky top-[100px] z-40 w-full px-3 flex flex-col items-center pointer-events-none">
		<ArticleIndexBar headings={headings} />
	</div>
)}

<article class="flex flex-col gap-9">
  <ArticleHeader id={id} pubDate={pubDate} tags={tags} title={title} />
  {heroImage && (
    <div class="w-full rounded-xl overflow-hidden" transition:name={`hero-image-${id}`}>
      <Image width={1080} height={540} src={heroImage} alt={title} class="w-full h-auto" />
    </div>
  )}
  <ArticleIndex headings={headings} id="article-index" />
  <slot />
</article>
{(prevArticle || nextArticle) && (
  <div class="flex flex-col gap-6 pt-12 mt-12 border-t border-app-border-default-reverse">
    {nextArticle && (
      <div class="flex flex-col gap-2.5">
        <h3 class="text-base font-bold text-app-text">
          Next
        </h3>
        <div class="px-3">
          <ArticleCard entry={nextArticle} />
        </div>
      </div>
    )}
    {prevArticle && (
      <div class="flex flex-col gap-2.5">
        <h3 class="text-base font-bold text-app-text">
          Previous
        </h3>
        <div class="px-3">
          <ArticleCard entry={prevArticle} />
        </div>
      </div>
    )}
  </div>
)}

<script is:inline>
	// Alpine.js Store初期化
	document.addEventListener('alpine:init', () => {
		if (typeof Alpine !== 'undefined') {
			Alpine.store("articleIndexBar", {
				show: false,
				toggleShow() {
					this.show = !this.show;
				},
				expanded: false,
				toggleExpanded() {
					this.expanded = !this.expanded;
				}
			});
		}
	});

	const setupIndexToggle = () => {
		const articleIndex = document.getElementById('article-index');
		const indexContent = document.getElementById('index-content');

		if (!articleIndex || !indexContent) return;

		const store = Alpine.store('articleIndexBar');
		if (!store) return;

		// 目次リンククリック時に目次を閉じる
		const indexLinks = indexContent.querySelectorAll('a');
		indexLinks.forEach(link => {
			link.addEventListener('click', () => {
				Alpine.store('articleIndexBar').expanded = false;
			});
		});

		// 既存のリスナーをクリーンアップ
		if (window.__indexToggleScrollHandler) {
			window.removeEventListener('scroll', window.__indexToggleScrollHandler, { passive: true });
		}

		const handleScroll = () => {
			const store = Alpine.store('articleIndexBar');
			if (!store) return;

			const scrollY = window.scrollY;
			// ページ全体の縦幅の10%を超えたら表示
			const scrollHeight = document.documentElement.scrollHeight;
			const threshold = scrollHeight * 0.1;
			if (scrollY > threshold) {
				Alpine.store('articleIndexBar').show = true;
			} else {
				Alpine.store('articleIndexBar').show = false;
			}
		};
		// スクロールイベントリスナーを追加
		window.addEventListener('scroll', handleScroll, { passive: true });
		window.__indexToggleScrollHandler = handleScroll;

		// 初回チェック
		handleScroll();
	};

	setupIndexToggle();
	document.addEventListener('astro:before-swap', () => {
		if (window.__indexToggleScrollHandler) {
			window.removeEventListener('scroll', window.__indexToggleScrollHandler, { passive: true });
			window.__indexToggleScrollHandler = null;
		}
		setupIndexToggle();
	});
</script>
