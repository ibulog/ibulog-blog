name: microCMS API Schema Update

on:
  repository_dispatch:
    types: [microcms-api-schema-update]

jobs:
  update-microcms-schema:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update API schema file
        id: update-schema
        uses: actions/github-script@v7
        env:
          MICROCMS_SERVICE_DOMAIN: ${{ secrets.MICROCMS_SERVICE_DOMAIN }}
          MICROCMS_MANAGEMENT_API_KEY: ${{ secrets.MICROCMS_MANAGEMENT_API_KEY }}
        with:
          script: |
            const { updateSchemaFile } = await import('${{ github.workspace }}/.github/scripts/update-schema-file.js');

            try {
              const result = await updateSchemaFile(
                ${{ toJson(github.event.client_payload) }},
                process.env.MICROCMS_SERVICE_DOMAIN,
                process.env.MICROCMS_MANAGEMENT_API_KEY
              );
              core.setOutput('api_name', result.apiName);
              core.setOutput('branch_name', result.branchName);
            } catch (error) {
              core.setFailed(error);
            }

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.update-schema.outputs.branch_name }}
          title: "chore: ${{ steps.update-schema.outputs.api_name }}のAPIスキーマ更新"
          body: |
            microCMSのAPIスキーマが更新されました。
            
            - API: `${{ steps.update-schema.outputs.api_name }}`
            - Service: `${{ steps.update-schema.outputs.service_name }}`
            
            このPRは自動生成されました。
          delete-branch: true
